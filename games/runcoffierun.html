<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Run Coffey Run - Canvas Editie</title>
    
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/game.css">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="../js/effects.js"></script>   

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="../js/leaderboard-manager.js"></script>

    <style>
        .runner-wrapper {
            position: relative;
            background-color: #87CEEB; 
            overflow: hidden; 
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .start-hint {
            z-index: 20;
            pointer-events: none; 
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="score-board">
        <div class="score-group">
            <div class="score-item">
                <span class="score-label">Score</span>
                <span id="scoreValue" class="score-value">0</span>
            </div>
            <div class="score-item">
                <span class="score-label">Highscore</span>
                <span id="highScoreValue" class="score-value">0</span>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="icon-btn" onclick="openLeaderboard()" title="Topscores">üèÜ</button>
            <button class="reset-btn" onclick="resetGame()" title="Reset">‚Üª</button>
        </div>
    </div>

    <div class="runner-wrapper" id="gameWrapper">
        <canvas id="gameCanvas" width="800" height="400"></canvas>

        <div id="startHint" class="start-hint">
            <div style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 8px; display:inline-block;">
                <strong>TAP OM TE STARTEN</strong><br>
                <span style="font-size:0.8em;">Spring over de schildpadden</span>
            </div>
        </div>
    </div>

    <div id="gameOverMsg" class="win-message hidden">
        <h3>Horde geraakt!</h3>
        <p>Je eindscore is: <span id="finalScore" style="font-weight:bold; font-size:1.2em;">0</span></p>
        
        <div class="input-area">
            <input type="text" id="playerName" placeholder="Manager Naam" maxlength="15">
            <button class="save-btn" id="saveButton" onclick="saveScore()">Opslaan</button>
        </div>
        <button class="close-msg-btn" style="background:#888;" onclick="resetGame()">Nog een keer</button>
    </div>

</div>

<div id="leaderboardModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">üèÜ Run Coffie Run Top 3 üèÜ</div>
        <ul id="highScoreList" class="highscore-list">
            <li><span>Laden...</span></li>
        </ul>
        <button class="close-btn" onclick="closeLeaderboard()">Sluiten</button>
    </div>
</div>

<script>
    // --- CANVAS SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 400;
    const GROUND_HEIGHT = 50; 

    // --- CONFIGURATIE HOOGTES (Breedte wordt hierop gebaseerd) ---
    const PLAYER_TARGET_HEIGHT = 130; // Iets groter gemaakt voor duidelijkheid
    const OBSTACLE_TARGET_HEIGHT = 40; 

    // --- HTML ELEMENTEN ---
    const scoreDisplay = document.getElementById("scoreValue");
    const highScoreDisplay = document.getElementById("highScoreValue");
    const startHint = document.getElementById("startHint");
    const gameOverMsg = document.getElementById("gameOverMsg");
    const finalScoreSpan = document.getElementById("finalScore");
    const saveBtn = document.getElementById('saveButton');
    const nameInput = document.getElementById('playerName');
    const highScoreList = document.getElementById('highScoreList');
    const gameWrapper = document.getElementById('gameWrapper');

    // --- ASSETS (AFBEELDINGEN LADEN) ---
    const imgCoffey = new Image();
    imgCoffey.src = 'images/coffie.png';
    const imgObstacle = new Image();
    imgObstacle.src = 'images/schildpad.png';
    const imgBg = new Image();
    imgBg.src = 'images/coffie-bg.png';

    // --- SPEL STATUS ---
    let isGameRunning = false;
    let isGameOver = false;
    let scoreSaved = false;
    let score = 0;
    let localHighScore = localStorage.getItem('coffeyHighScore') || 0;
    highScoreDisplay.innerText = localHighScore;

    // --- PHYSICS & LOGICA ---
    let gameSpeed = 400;
    let bgX = 0;
    let lastTime = 0;
    
    // Speler Object
    let player = {
        w: 60, // Startwaarde (wordt overschreven door auto-ratio)
        h: PLAYER_TARGET_HEIGHT, 
        x: 100,
        get startY() { return GAME_HEIGHT - GROUND_HEIGHT - this.h; }, 
        y: 0, 
        dy: 0,
        jumpForce: 750,
        gravity: 2000,
        grounded: true
    };
    player.y = player.startY;

    let obstacles = [];
    let obstacleTimer = 0;

    // --- INPUT HANDLING ---
    function handleInput(e) {
        if(e && e.type === 'touchstart') { /* prevent default */ }
        if (!isGameRunning && !isGameOver) {
            startGame();
        } else if (isGameRunning) {
            jump();
        }
    }

    window.addEventListener('keydown', e => {
        if (e.code === 'Space' || e.code === 'ArrowUp') {
            e.preventDefault(); 
            handleInput();
        }
    });
    gameWrapper.addEventListener('mousedown', handleInput);
    gameWrapper.addEventListener('touchstart', handleInput, {passive: false});

    window.addEventListener('DOMContentLoaded', () => {
        openLeaderboard();
    });

    // --- GAME ACTIES ---
    function jump() {
        if (player.grounded) {
            player.dy = -player.jumpForce;
            player.grounded = false;
        }
    }

    function startGame() {
        closeLeaderboard();
        isGameRunning = true;
        isGameOver = false;
        scoreSaved = false;
        startHint.style.display = 'none';
        gameOverMsg.classList.add('hidden');
        saveBtn.disabled = false;
        saveBtn.innerText = "Opslaan";
        saveBtn.style.opacity = "1";

        score = 0;
        gameSpeed = 400;
        scoreDisplay.innerText = "0";
        obstacles = [];
        player.y = player.startY;
        player.dy = 0;
        
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    // --- DE GAME LOOP ---
    function gameLoop(currentTime) {
        if (!isGameRunning) return;
        const dt = (currentTime - lastTime) / 1000;
        lastTime = currentTime;
        if (dt > 0.1) { requestAnimationFrame(gameLoop); return; }
        update(dt);
        draw();
        if (!isGameOver) { requestAnimationFrame(gameLoop); }
    }

    function update(dt) {
        score += dt * 10;
        scoreDisplay.innerText = Math.floor(score);
        gameSpeed = 400 + (score * 0.5); 

        bgX -= (gameSpeed * 0.5) * dt; 
        if (bgX <= -GAME_WIDTH) bgX = 0;

        // --- UPDATE SPELER AFMETINGEN (AUTO RATIO) ---
        // We doen dit hier zodat het direct werkt zodra het plaatje geladen is
        if (imgCoffey.complete && imgCoffey.naturalHeight > 0) {
            const ratio = imgCoffey.naturalWidth / imgCoffey.naturalHeight;
            player.w = player.h * ratio; // Breedte past zich aan aan de hoogte
        }

        player.dy += player.gravity * dt;
        player.y += player.dy * dt;

        if (player.y >= player.startY) {
            player.y = player.startY;
            player.dy = 0;
            player.grounded = true;
        } else {
            player.grounded = false;
        }

        obstacleTimer -= dt;
        if (obstacleTimer <= 0) {
            spawnObstacle();
            obstacleTimer = 1.0 + Math.random() * 1.0 - (score/5000);
            if(obstacleTimer < 0.6) obstacleTimer = 0.6; 
        }

        // Obstakels update
        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            obs.x -= gameSpeed * dt;
            if (obs.x + obs.w < 0) { obstacles.splice(i, 1); }

            // Hitbox padding (iets vergevingsgezinder)
            const pX = 20; 
            const pY = 12;

            if (
                player.x < obs.x + obs.w - pX &&
                player.x + player.w > obs.x + pX &&
                player.y < obs.y + obs.h - pY &&
                player.y + player.h > obs.y + pY
            ) {
                gameOver();
            }
        }
    }

    function draw() {
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

        // 1. Achtergrond
        if (imgBg.complete) {
            ctx.drawImage(imgBg, bgX, 0, GAME_WIDTH, GAME_HEIGHT);
            ctx.drawImage(imgBg, bgX + GAME_WIDTH, 0, GAME_WIDTH, GAME_HEIGHT);
        } else {
            ctx.fillStyle = "#87CEEB";
            ctx.fillRect(0,0, GAME_WIDTH, GAME_HEIGHT);
        }

        // 2. Speler
        if (imgCoffey.complete) {
            // Teken de speler met de berekende 'auto' breedte (player.w)
            ctx.drawImage(imgCoffey, player.x, player.y, player.w, player.h);
        } else {
            ctx.fillStyle = "red";
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }

        // 3. Obstakels
        obstacles.forEach(obs => {
            if (imgObstacle.complete) {
                ctx.drawImage(imgObstacle, obs.x, obs.y, obs.w, obs.h);
            } else {
                ctx.fillStyle = "green";
                ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
            }
        });
    }

    function spawnObstacle() {
        let obsH = OBSTACLE_TARGET_HEIGHT;
        let obsW = 50; // Fallback breedte

        // Bereken breedte op basis van ratio als plaatje geladen is
        if (imgObstacle.complete && imgObstacle.naturalHeight > 0) {
            const ratio = imgObstacle.naturalWidth / imgObstacle.naturalHeight;
            obsW = obsH * ratio;
        }
        
        obstacles.push({
            x: GAME_WIDTH,
            y: GAME_HEIGHT - GROUND_HEIGHT - obsH + 5, // +5 om hem iets 'in' het zand te zetten
            w: obsW,
            h: obsH
        });
    }

    // --- GAME OVER & SCORE ---
function gameOver() {
    isGameOver = true;
    isGameRunning = false;
    
    HattrickFX.shakeScreen(); 

    if (navigator.vibrate) navigator.vibrate([100, 50, 100]); 
    
    let finalScore = Math.floor(score);
    finalScoreSpan.innerText = finalScore;
    gameOverMsg.classList.remove('hidden');

    if (finalScore > localHighScore) {
        localHighScore = finalScore;
        localStorage.setItem('coffeyHighScore', localHighScore);
        highScoreDisplay.innerText = localHighScore;
        
        HattrickFX.highScore(); 
    }
}

    function resetGame() {
        isGameOver = false;
        isGameRunning = false;
        startHint.style.display = 'block';
        gameOverMsg.classList.add('hidden');
        score = 0;
        scoreDisplay.innerText = 0;
        
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        if (imgBg.complete) ctx.drawImage(imgBg, 0, 0, GAME_WIDTH, GAME_HEIGHT);
        
        // Update player position voor reset (rekening houdend met nieuwe hoogte)
        player.y = player.startY;
        if (imgCoffey.complete) ctx.drawImage(imgCoffey, player.x, player.y, player.w, player.h);
    }

    function saveScore() {
        if (scoreSaved) return;
        const name = nameInput.value.trim() || "Anoniem";
        const finalPoints = Math.floor(score);
        scoreSaved = true;
        saveBtn.disabled = true;
        saveBtn.innerText = "Bezig...";
        saveBtn.style.opacity = "0.7";

        LeaderboardManager.saveScore("coffey_scores", name, finalPoints, () => {
            saveBtn.innerText = "Opgeslagen!";
            setTimeout(() => {
                gameOverMsg.classList.add('hidden');
                openLeaderboard(); 
            }, 500);
        });
    }

    function openLeaderboard() {
        document.getElementById('leaderboardModal').style.display = 'flex';
        LeaderboardManager.loadTop10("coffey_scores", "highScoreList", "desc");
    }

    function closeLeaderboard() {
        document.getElementById('leaderboardModal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('leaderboardModal');
        if (event.target == modal) { closeLeaderboard(); }
    }
</script>

</body>
</html>